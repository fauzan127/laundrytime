name: Auto Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy to VPS
        run: |
          echo "üöÄ Starting deployment to VPS..."

          # Deploy commands via SSH
          ssh -o StrictHostKeyChecking=no root@72.60.74.187 << 'EOF'
            set -e
            echo "üìÇ Navigating to project directory..."
            cd /var/www/laundrytime.cloud

            # Backup current .env if it exists
            if [ -f .env ]; then
              echo "üì¶ Backing up .env file..."
              cp .env .env.backup
            fi

            # Pull latest changes
            echo "üì• Pulling latest changes from git..."
            git pull origin main

            # Restore .env if backup exists
            if [ -f .env.backup ]; then
              echo "üì¶ Restoring .env file..."
              cp .env.backup .env
            fi

            # Stop existing containers
            echo "üõë Stopping existing containers..."
            docker-compose down || true

            # Remove old images to free space
            echo "üßπ Cleaning up old Docker images..."
            docker image prune -f || true

            # Build and start containers
            echo "üèóÔ∏è Building and starting containers..."
            docker-compose up -d --build

            # Wait for containers to be healthy
            echo "‚è≥ Waiting for containers to be ready..."
            sleep 30

            # Run Laravel post-deploy tasks
            echo "üîß Running Laravel post-deploy tasks..."
            docker-compose exec -T app php artisan migrate --force || echo "Migration failed, check logs"
            docker-compose exec -T app php artisan config:clear || true
            docker-compose exec -T app php artisan cache:clear || true
            docker-compose exec -T app php artisan view:clear || true
            docker-compose exec -T app php artisan route:clear || true
            docker-compose exec -T app chown -R www-data:www-data storage bootstrap/cache || true

            # Check if app is responding
            echo "üîç Checking if application is responding..."
            if curl -f http://localhost > /dev/null 2>&1; then
              echo "‚úÖ Deployment successful! Application is responding."
            else
              echo "‚ùå Deployment completed but application may not be responding. Check logs."
            fi

            echo "üìä Deployment finished at $(date)"
          EOF
